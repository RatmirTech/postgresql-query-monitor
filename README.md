# üêò PostgreSQL Query Monitor CLI (`pgmon`)

CLI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Å–±–æ—Ä–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ PostgreSQL, SQL-—Ñ–∞–π–ª–æ–≤ –∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫. –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å Vault –∏ –≤–Ω–µ—à–Ω–∏–º API –∞–Ω–∞–ª–∏–∑–∞.

---

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏:

VAULT_TOKEN=your-vault-token-here
REVIEW_API_URL=https://your-review-api.example.com
ENVIRONMENT=production
VAULT_ADDR=http://localhost:8200


> üí° `godotenv` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∑–∏—Ç —ç—Ç–æ—Ç —Ñ–∞–π–ª –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ.


---

## üß≠ –ö–æ–º–∞–Ω–¥—ã

### `pgmon csi` ‚Äî –°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ—Ä–≤–µ—Ä–µ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–°–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ —Å–µ—Ä–≤–µ—Ä–µ PostgreSQL —á–µ—Ä–µ–∑ Vault –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –Ω–∞ –∞–Ω–∞–ª–∏–∑ (–±–µ–∑ –º–µ—Ç—Ä–∏–∫).

#### üè∑Ô∏è –§–ª–∞–≥–∏

| –§–ª–∞–≥ | –û–ø–∏—Å–∞–Ω–∏–µ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|------|----------|--------------|--------------|
| `--vp` | –ü—É—Ç—å –≤ Vault, –≥–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL | ‚úÖ –î–∞ | ‚Äî |
| `--st` | –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–∞–¥–∞—á–∞ –∑–∞–ø—É—â–µ–Ω–Ω–æ–π –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (scheduler task) | ‚ùå –ù–µ—Ç | `false` |

#### üìå –ü—Ä–∏–º–µ—Ä—ã

pgmon csi --vp="secret/data/postgres/prod"

pgmon csi --vp="secret/data/postgres/staging" --st=true

---

### `pgmon csf` ‚Äî –°–±–æ—Ä –∏ –∞–Ω–∞–ª–∏–∑ SQL-—Ñ–∞–π–ª–æ–≤

–°–∫–∞–Ω–∏—Ä—É–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –Ω–∞ –Ω–∞–ª–∏—á–∏–µ SQL-—Ñ–∞–π–ª–æ–≤, —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ —Ä–µ–∂–∏–º—É –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ –∞–Ω–∞–ª–∏–∑.


#### üè∑Ô∏è –§–ª–∞–≥–∏

| –§–ª–∞–≥ | –û–ø–∏—Å–∞–Ω–∏–µ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|------|----------|--------------|--------------|
| `--dir` | –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è | ‚ùå –ù–µ—Ç | `.` (—Ç–µ–∫—É—â–∞—è) |
| `--mode` | –†–µ–∂–∏–º –ø–æ–∏—Å–∫–∞: `all`, `migrations`, `specific` | ‚ùå –ù–µ—Ç | `all` |
| `--vp` | –ü–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –º–∏–≥—Ä–∞—Ü–∏–π (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –µ—Å–ª–∏ `--mode=migrations`) | ‚ùå –ù–µ—Ç | ‚Äî |
| `--files` | –°–ø–∏—Å–æ–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –µ—Å–ª–∏ `--mode=specific`) | ‚ùå –ù–µ—Ç | `[]` |
| `--enable-ignore` | –í–∫–ª—é—á–∏—Ç—å –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–∞ `--ignore` | ‚ùå –ù–µ—Ç | `false` |
| `--ignore` | –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è (–∏–º–µ–Ω–∞ –∏–ª–∏ –ø—É—Ç–∏) | ‚ùå –ù–µ—Ç | `[]` |

#### üìå –ü—Ä–∏–º–µ—Ä—ã

pgmon csf

pgmon csf --mode=migrations --vp="migrations"

pgmon csf --mode=specific --files="init.sql,users.sql"

pgmon csf --enable-ignore --ignore="deprecated.sql,old_views.sql"

pgmon csf --dir="./sql" --mode=migrations --vp="db/migrations" --enable-ignore --ignore="rollback.sql"

---

### `pgmon csm` ‚Äî –°–±–æ—Ä —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ—Ä–≤–µ—Ä–µ

–°–æ–±–∏—Ä–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (CPU, RAM, –¥–∏—Å–∫–∏ –∏ —Ç.–¥.) + –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Ä–≤–µ—Ä–µ PostgreSQL –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ –∞–Ω–∞–ª–∏–∑.

#### üè∑Ô∏è –§–ª–∞–≥–∏

| –§–ª–∞–≥ | –û–ø–∏—Å–∞–Ω–∏–µ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|------|----------|--------------|--------------|
| `--vp` | –ü—É—Ç—å –≤ Vault, –≥–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL | ‚úÖ –î–∞ | ‚Äî |
| `--st` | –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–∞–¥–∞—á–∞ –∑–∞–ø—É—â–µ–Ω–Ω–æ–π –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (scheduler task) | ‚ùå –ù–µ—Ç | `false` |

#### üìå –ü—Ä–∏–º–µ—Ä—ã

pgmon csm --vp="secret/data/postgres/prod"

pgmon csm --vp="secret/data/postgres/prod" --st=true

---

## üõ†Ô∏è –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ SQL-—Ñ–∞–π–ª–æ–≤

–í –∫–æ–º–∞–Ω–¥–µ `csf` –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ API –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞. –ß—Ç–æ–±—ã –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å:

1. –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –±–ª–æ–∫ –∫–æ–¥–∞, –Ω–∞—á–∏–Ω–∞—é—â–∏–π—Å—è —Å:
   // –°–æ–∑–¥–∞—ë–º –∫–ª–∏–µ–Ω—Ç–∞
   // ctx := context.Background()
   // apiClient := client.NewClient(cfg.ReviewAPI.URL)

2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `ReviewAPI.URL` –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ –∏–ª–∏ `.env`.

3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã `models.QueryReviewRequest`, `models.BatchReviewRequest`, `models.MigrationReviewRequest` —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç API.

---

## üß™ –ü—Ä–∏–º–µ—Ä—ã –ø–æ–ª–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

pgmon csi --vp="secret/data/pg/main" --st=true

pgmon csf --dir="./sql" --mode=all --enable-ignore --ignore="temp.sql"

pgmon csm --vp="secret/data/pg/main" --st=false

---

## ‚ùó –û—à–∏–±–∫–∏ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

- `Vault path is required` ‚Äî –Ω–µ —É–∫–∞–∑–∞–Ω —Ñ–ª–∞–≥ `--vp` –¥–ª—è –∫–æ–º–∞–Ω–¥, —Ç—Ä–µ–±—É—é—â–∏—Ö –¥–æ—Å—Ç—É–ø –∫ Vault.
- `Failed to load config` ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ `.env` —Ñ–∞–π–ª–∞ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö.
- `Failed to create Vault client` ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Vault –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞.
- `No SQL files found` ‚Äî –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –Ω–µ—Ç `.sql` —Ñ–∞–π–ª–æ–≤, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–∞–º.

---

## üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- github.com/spf13/cobra ‚Äî CLI —Ñ—Ä–µ–π–º–≤–æ—Ä–∫.
- github.com/hashicorp/vault/api ‚Äî –∫–ª–∏–µ–Ω—Ç Vault.
- github.com/joho/godotenv ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ `.env`.
- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø–∞–∫–µ—Ç—ã: `collectors`, `serverinfo`, `sqlfiles`, `review`, `config`.

 ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ CI/CD, —Å–∫—Ä–∏–ø—Ç–∞—Ö –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ —Ä—É—á–Ω–æ–º –∑–∞–ø—É—Å–∫–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏ –ë–î.